> ğŸ“ Click on the language section to expand / è¨€èªã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹

# Advanced configuration / é«˜åº¦ãªè¨­å®š

## How to specify `network_args` / `network_args`ã®æŒ‡å®šæ–¹æ³•

<details>
<summary>English</summary>
The `--network_args` option is an option for specifying detailed arguments to LoRA. Specify the arguments in the form of `key=value` in `--network_args`.
</details>

<details>
<summary>æ—¥æœ¬èª</summary>
`--network_args`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€LoRAã¸ã®è©³ç´°ãªå¼•æ•°ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚`--network_args`ã«ã¯ã€`key=value`ã®å½¢å¼ã§å¼•æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚
</details>

### Example / è¨˜è¿°ä¾‹

If you specify it on the command line, write as follows. / ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§æŒ‡å®šã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```bash
accelerate launch --num_cpu_threads_per_process 1 --mixed_precision bf16 hv_train_network.py --dit ... 
    --network_module networks.lora --network_dim 32 
    --network_args "key1=value1" "key2=value2" ...
```

If you specify it in the configuration file, write as follows. / è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§æŒ‡å®šã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```toml
network_args = ["key1=value1", "key2=value2", ...]
```

If you specify `"verbose=True"`, detailed information of LoRA will be displayed. / `"verbose=True"`ã‚’æŒ‡å®šã™ã‚‹ã¨LoRAã®è©³ç´°ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```bash
--network_args "verbose=True" "key1=value1" "key2=value2" ...
```

## LoRA+

<details>
<summary>English</summary>

LoRA+ is a method to improve the training speed by increasing the learning rate of the UP side (LoRA-B) of LoRA. Specify the multiplier for the learning rate. The original paper recommends 16, but adjust as needed. It seems to be good to start from around 4. For details, please refer to the [related PR of sd-scripts](https://github.com/kohya-ss/sd-scripts/pull/1233).

Specify `loraplus_lr_ratio` with `--network_args`.
</details>

<details>
<summary>æ—¥æœ¬èª</summary>

LoRA+ã¯ã€LoRAã®UPå´ï¼ˆLoRA-Bï¼‰ã®å­¦ç¿’ç‡ã‚’ä¸Šã’ã‚‹ã“ã¨ã§å­¦ç¿’é€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã‚‹æ‰‹æ³•ã§ã™ã€‚å­¦ç¿’ç‡ã«å¯¾ã™ã‚‹å€ç‡ã‚’æŒ‡å®šã—ã¾ã™ã€‚å…ƒè«–æ–‡ã§ã¯16ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ãŒã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚4ç¨‹åº¦ã‹ã‚‰å§‹ã‚ã‚‹ã¨ã‚ˆã„ã‚ˆã†ã§ã™ã€‚è©³ç´°ã¯[sd-scriptsã®é–¢é€£PR]https://github.com/kohya-ss/sd-scripts/pull/1233)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

`--network_args`ã§`loraplus_lr_ratio`ã‚’æŒ‡å®šã—ã¾ã™ã€‚
</details>

### Example / è¨˜è¿°ä¾‹

```bash
accelerate launch --num_cpu_threads_per_process 1 --mixed_precision bf16 hv_train_network.py --dit ... 
    --network_module networks.lora --network_dim 32 --network_args "loraplus_lr_ratio=4" ...
```

## Select the target modules of LoRA / LoRAã®å¯¾è±¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¸æŠã™ã‚‹

*This feature is highly experimental and the specification may change. / ã“ã®æ©Ÿèƒ½ã¯ç‰¹ã«å®Ÿé¨“çš„ãªã‚‚ã®ã§ã€ä»•æ§˜ã¯å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚*

<details>
<summary>English</summary>

By specifying `exclude_patterns` and `include_patterns` with `--network_args`, you can select the target modules of LoRA.

`exclude_patterns` excludes modules that match the specified pattern. `include_patterns` targets only modules that match the specified pattern.

Specify the values as a list. For example, `"exclude_patterns=[r'.*single_blocks.*', r'.*double_blocks\.[0-9]\..*']"`.

The pattern is a regular expression for the module name. The module name is in the form of `double_blocks.0.img_mod.linear` or `single_blocks.39.modulation.linear`. The regular expression is not a partial match but a complete match.

The patterns are applied in the order of `exclude_patterns`â†’`include_patterns`. By default, the Linear layers of `img_mod`, `txt_mod`, and `modulation` of double blocks and single blocks are excluded.

(`.*(img_mod|txt_mod|modulation).*` is specified.)
</details>

<details>
<summary>æ—¥æœ¬èª</summary>

`--network_args`ã§`exclude_patterns`ã¨`include_patterns`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€LoRAã®å¯¾è±¡ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`exclude_patterns`ã¯ã€æŒ‡å®šã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é™¤å¤–ã—ã¾ã™ã€‚`include_patterns`ã¯ã€æŒ‡å®šã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¾ã™ã€‚

å€¤ã¯ã€ãƒªã‚¹ãƒˆã§æŒ‡å®šã—ã¾ã™ã€‚`"exclude_patterns=[r'.*single_blocks.*', r'.*double_blocks\.[0-9]\..*']"`ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã«å¯¾ã™ã‚‹æ­£è¦è¡¨ç¾ã§ã™ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã¯ã€ãŸã¨ãˆã°`double_blocks.0.img_mod.linear`ã‚„`single_blocks.39.modulation.linear`ã®ã‚ˆã†ãªå½¢å¼ã§ã™ã€‚æ­£è¦è¡¨ç¾ã¯éƒ¨åˆ†ä¸€è‡´ã§ã¯ãªãå®Œå…¨ä¸€è‡´ã§ã™ã€‚

ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€`exclude_patterns`â†’`include_patterns`ã®é †ã§é©ç”¨ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€double blocksã¨single blocksã®Linearå±¤ã®ã†ã¡ã€`img_mod`ã€`txt_mod`ã€`modulation`ãŒé™¤å¤–ã•ã‚Œã¦ã„ã¾ã™ã€‚

ï¼ˆ`.*(img_mod|txt_mod|modulation).*`ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ï¼‰
</details>

### Example / è¨˜è¿°ä¾‹

Only the modules of double blocks / double blocksã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹å ´åˆ:

```bash
--network_args "exclude_patterns=[r'.*single_blocks.*']"
```

Only the modules of single blocks from the 10th / single blocksã®10ç•ªç›®ä»¥é™ã®Linearãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹å ´åˆ:

```bash
--network_args "exclude_patterns=[r'.*']" "include_patterns=[r'.*single_blocks\.\d{2}\.linear.*']"
```
